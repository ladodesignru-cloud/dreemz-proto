<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DREEMZ: Heaven Signal V5</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
        #noise { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.3; pointer-events: none; }
        .ellipse { width: 220px; height: 350px; border: 2px solid #222; border-radius: 110px / 175px; display: flex; align-items: center; justify-content: center; position: relative; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: translateY(50px); opacity: 0.5; }
        .active { border-color: #0ff; box-shadow: 0 0 50px #0ff; transform: translateY(0) scale(1.1); opacity: 1; }
        .status { margin-top: 40px; font-size: 0.7em; letter-spacing: 4px; text-transform: uppercase; color: #333; padding: 0 20px; }
        #btn { padding: 18px 40px; background: #0ff; color: #000; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; z-index: 10; box-shadow: 0 0 20px rgba(0,255,255,0.3); }
        .debug-box { position: absolute; top: 10px; left: 10px; text-align: left; font-size: 10px; color: #444; font-family: monospace; }
        .lock-notice { font-size: 1.2em; color: #0ff; text-shadow: 0 0 15px #0ff; display: none; font-weight: bold; }
        #instruction { position: absolute; bottom: 100px; width: 100%; font-size: 0.9em; color: #666; animation: pulse 2s infinite; display: none; }
        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }
    </style>
</head>
<body>
    <canvas id="noise"></canvas>
    
    <div id="setup">
        <button id="btn">ПОЙМАТЬ СИГНАЛ С НЕБЕС</button>
    </div>

    <div id="portal" class="ellipse" style="display:none">
        <div id="lock-label" class="lock-notice">HEAVEN SIGNAL LOCKED</div>
    </div>

    <div class="status" id="status-text" style="display:none">ПОДНИМИТЕ ТЕЛЕФОН К НЕБУ</div>
    
    <div id="instruction">ПОДНИМАЙ ВЫШЕ...</div>

    <div class="debug-box" id="dbg">SENSOR STATUS: WAITING...</div>

    <script>
        const canvas = document.getElementById('noise');
        const ctx = canvas.getContext('2d');
        const portal = document.getElementById('portal');
        const label = document.getElementById('lock-label');
        const statusText = document.getElementById('status-text');
        const btn = document.getElementById('btn');
        const dbg = document.getElementById('dbg');
        const setup = document.getElementById('setup');
        const instr = document.getElementById('instruction');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.onresize = resize;
        resize();

        function drawNoise() {
            const idata = ctx.createImageData(canvas.width, canvas.height);
            const buffer = new Uint32Array(idata.data.buffer);
            for (let i = 0; i < buffer.length; i++) {
                if (Math.random() < 0.5) buffer[i] = 0xff000000;
                else buffer[i] = 0xffffffff;
            }
            ctx.putImageData(idata, 0, 0);
            requestAnimationFrame(drawNoise);
        }
        drawNoise();

        function updateSignal(beta) {
            // beta is front-to-back tilt. 0 is flat, -90 is vertical pointing up.
            // Target: raised to the sky (beta between -60 and -110)
            const target = -85;
            const diff = Math.abs(beta - target);
            
            dbg.innerText = `SKY ANGLE: ${Math.round(beta)}° | DIFF: ${Math.round(diff)}`;

            if (diff < 20) {
                portal.classList.add('active');
                label.style.display = 'block';
                statusText.innerText = 'СИГНАЛ С НЕБЕС ПОЙМАН';
                statusText.style.color = '#0ff';
                canvas.style.opacity = 0.03;
                instr.style.display = 'none';
            } else {
                portal.classList.remove('active');
                label.style.display = 'none';
                statusText.innerText = 'ПОДНИМИТЕ ТЕЛЕФОН К НЕБУ';
                statusText.style.color = '#444';
                canvas.style.opacity = 0.3;
                instr.style.display = 'block';
                if (beta > -30) instr.innerText = "ПОДНИМАЙ ВЫШЕ...";
                else if (beta < -120) instr.innerText = "ОПУСТИ НЕМНОГО...";
            }
        }

        btn.onclick = async () => {
            try {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response === 'granted') startApp('gyro');
                    else alert("Нужен доступ к датчикам!");
                } else {
                    startApp('gyro');
                }
            } catch (err) {
                console.error(err);
                startApp('touch'); // Fallback
            }
        };

        function startApp(mode) {
            setup.style.display = 'none';
            portal.style.display = 'flex';
            statusText.style.display = 'block';
            instr.style.display = 'block';

            if (mode === 'gyro') {
                window.addEventListener('deviceorientation', (e) => {
                    updateSignal(e.beta);
                });
            } else {
                // Touch fallback: slide from bottom to top
                window.addEventListener('touchmove', (e) => {
                    let val = (e.touches[0].clientY / window.innerHeight) * -180 + 90;
                    updateSignal(val);
                });
            }
        }
    </script>
</body>
</html>
