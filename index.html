<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DREEMZ: Sensor Probe V4</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
        #noise { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.2; pointer-events: none; }
        .ellipse { width: 200px; height: 320px; border: 2px solid #333; border-radius: 100px / 160px; display: flex; align-items: center; justify-content: center; position: relative; transition: all 0.2s; }
        .active { border-color: #0ff; box-shadow: 0 0 30px #0ff; transform: scale(1.1); }
        .status { margin-top: 30px; font-size: 0.7em; letter-spacing: 3px; text-transform: uppercase; color: #444; padding: 0 20px; }
        #btn { padding: 15px 30px; background: #0ff; color: #000; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; z-index: 10; }
        .debug-box { position: absolute; top: 10px; left: 10px; text-align: left; font-size: 10px; color: #555; font-family: monospace; }
        .lock-notice { font-size: 1.2em; color: #0ff; text-shadow: 0 0 10px #0ff; display: none; }
    </style>
</head>
<body>
    <canvas id="noise"></canvas>
    
    <div id="setup">
        <button id="btn">РАЗРЕШИТЬ ДОСТУП</button>
        <p style="font-size: 10px; color: #444; margin-top: 10px;">Для работы датчиков на iPhone/Android<br>нужен HTTPS. Если не работает — используй пальцы.</p>
    </div>

    <div id="portal" class="ellipse" style="display:none">
        <div id="lock-label" class="lock-notice">SIGNAL LOCKED</div>
    </div>

    <div class="status" id="status-text" style="display:none">ПОИСК СИГНАЛА</div>
    
    <div class="debug-box" id="dbg">
        SENSOR STATUS: WAITING...
    </div>

    <script>
        const canvas = document.getElementById('noise');
        const ctx = canvas.getContext('2d');
        const portal = document.getElementById('portal');
        const label = document.getElementById('lock-label');
        const statusText = document.getElementById('status-text');
        const btn = document.getElementById('btn');
        const dbg = document.getElementById('dbg');
        const setup = document.getElementById('setup');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.onresize = resize;
        resize();

        function drawNoise() {
            const idata = ctx.createImageData(canvas.width, canvas.height);
            const buffer = new Uint32Array(idata.data.buffer);
            for (let i = 0; i < buffer.length; i++) {
                if (Math.random() < 0.5) buffer[i] = 0xff000000;
                else buffer[i] = 0xffffffff;
            }
            ctx.putImageData(idata, 0, 0);
            requestAnimationFrame(drawNoise);
        }
        drawNoise();

        function updateSignal(val) {
            const target = 68;
            const diff = Math.abs(val - target);
            dbg.innerText = `VAL: ${Math.round(val)} | TRGT: ${target} | DIFF: ${Math.round(diff)}`;

            if (diff < 10) {
                portal.classList.add('active');
                label.style.display = 'block';
                statusText.innerText = 'СИГНАЛ ПОЙМАН';
                statusText.style.color = '#0ff';
                canvas.style.opacity = 0.05;
            } else {
                portal.classList.remove('active');
                label.style.display = 'none';
                statusText.innerText = 'ПОИСК ЧАСТОТЫ...';
                statusText.style.color = '#444';
                canvas.style.opacity = 0.25;
            }
        }

        btn.onclick = async () => {
            dbg.innerText = "REQUESTING PERMISSION...";
            
            try {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response === 'granted') {
                        setup.style.display = 'none';
                        portal.style.display = 'flex';
                        statusText.style.display = 'block';
                        window.addEventListener('deviceorientation', (e) => {
                            let val = ((e.gamma + 90) / 180) * 100;
                            updateSignal(val);
                        });
                    } else {
                        dbg.innerText = "PERMISSION DENIED";
                    }
                } else {
                    // Non-iOS or older device
                    setup.style.display = 'none';
                    portal.style.display = 'flex';
                    statusText.style.display = 'block';
                    window.addEventListener('deviceorientation', (e) => {
                        let val = ((e.gamma + 90) / 180) * 100;
                        updateSignal(val);
                    });
                }
            } catch (err) {
                dbg.innerText = "ERROR: " + err.message;
            }

            // Fallback touch for everyone
            window.addEventListener('touchmove', (e) => {
                let val = (e.touches[0].clientX / window.innerWidth) * 100;
                updateSignal(val);
            });
        };
    </script>
</body>
</html>
